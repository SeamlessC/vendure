import { Subject } from 'rxjs';
/**
 * @description
 * A helper class used to manage selection of list items. Supports multiple selection via
 * cmd/ctrl/shift key.
 */
export class SelectionManager {
    constructor(options) {
        this.options = options;
        this._selection = [];
        this.items = [];
        this.selectionChangesSubject = new Subject();
        this.selectionChanges$ = this.selectionChangesSubject.asObservable();
    }
    get selection() {
        return this._selection;
    }
    setMultiSelect(isMultiSelect) {
        this.options.multiSelect = isMultiSelect;
    }
    setCurrentItems(items) {
        this.items = items;
    }
    toggleSelection(item, event) {
        const { multiSelect, itemsAreEqual, additiveMode } = this.options;
        const index = this._selection.findIndex(a => itemsAreEqual(a, item));
        if (multiSelect && (event === null || event === void 0 ? void 0 : event.shiftKey) && 1 <= this._selection.length) {
            const lastSelection = this._selection[this._selection.length - 1];
            const lastSelectionIndex = this.items.findIndex(a => itemsAreEqual(a, lastSelection));
            const currentIndex = this.items.findIndex(a => itemsAreEqual(a, item));
            const start = currentIndex < lastSelectionIndex ? currentIndex : lastSelectionIndex;
            const end = currentIndex > lastSelectionIndex ? currentIndex + 1 : lastSelectionIndex;
            this._selection.push(...this.items.slice(start, end).filter(a => !this._selection.find(s => itemsAreEqual(a, s))));
        }
        else if (index === -1) {
            if (multiSelect && ((event === null || event === void 0 ? void 0 : event.ctrlKey) || (event === null || event === void 0 ? void 0 : event.shiftKey) || additiveMode)) {
                this._selection.push(item);
            }
            else {
                this._selection = [item];
            }
        }
        else {
            if (multiSelect && (event === null || event === void 0 ? void 0 : event.ctrlKey)) {
                this._selection.splice(index, 1);
            }
            else if (1 < this._selection.length && !additiveMode) {
                this._selection = [item];
            }
            else {
                this._selection.splice(index, 1);
            }
        }
        // Make the selection mutable
        this._selection = this._selection.map(x => (Object.assign({}, x)));
        this.invokeOnSelectionChangeHandler();
    }
    selectMultiple(items) {
        this._selection = items;
        this.invokeOnSelectionChangeHandler();
    }
    clearSelection() {
        this._selection = [];
        this.invokeOnSelectionChangeHandler();
    }
    isSelected(item) {
        return !!this._selection.find(a => this.options.itemsAreEqual(a, item));
    }
    areAllCurrentItemsSelected() {
        if (!this.items || this.items.length === 0) {
            return false;
        }
        return this.items.every(a => this._selection.find(b => this.options.itemsAreEqual(a, b)));
    }
    toggleSelectAll() {
        if (this.areAllCurrentItemsSelected()) {
            this._selection = this._selection.filter(a => !this.items.find(b => this.options.itemsAreEqual(a, b)));
        }
        else {
            this._selection = this._selection.slice(0);
            for (const item of this.items) {
                if (!this._selection.find(a => this.options.itemsAreEqual(a, item))) {
                    this._selection.push(item);
                }
            }
        }
        this.invokeOnSelectionChangeHandler();
    }
    lastSelected() {
        return this._selection[this._selection.length - 1];
    }
    invokeOnSelectionChangeHandler() {
        this.selectionChangesSubject.next(this._selection);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0aW9uLW1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvbGliL2NvcmUvc3JjL2NvbW1vbi91dGlsaXRpZXMvc2VsZWN0aW9uLW1hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFjLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQVEzQzs7OztHQUlHO0FBQ0gsTUFBTSxPQUFPLGdCQUFnQjtJQUN6QixZQUFvQixPQUFtQztRQUFuQyxZQUFPLEdBQVAsT0FBTyxDQUE0QjtRQVUvQyxlQUFVLEdBQVEsRUFBRSxDQUFDO1FBQ3JCLFVBQUssR0FBUSxFQUFFLENBQUM7UUFDaEIsNEJBQXVCLEdBQUcsSUFBSSxPQUFPLEVBQU8sQ0FBQztRQVhqRCxJQUFJLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxDQUFDLHVCQUF1QixDQUFDLFlBQVksRUFBRSxDQUFDO0lBQ3pFLENBQUM7SUFFRCxJQUFJLFNBQVM7UUFDVCxPQUFPLElBQUksQ0FBQyxVQUFVLENBQUM7SUFDM0IsQ0FBQztJQVFELGNBQWMsQ0FBQyxhQUFzQjtRQUNqQyxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsR0FBRyxhQUFhLENBQUM7SUFDN0MsQ0FBQztJQUVELGVBQWUsQ0FBQyxLQUFVO1FBQ3RCLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO0lBQ3ZCLENBQUM7SUFFRCxlQUFlLENBQUMsSUFBTyxFQUFFLEtBQWtCO1FBQ3ZDLE1BQU0sRUFBRSxXQUFXLEVBQUUsYUFBYSxFQUFFLFlBQVksRUFBRSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUM7UUFDbEUsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxhQUFhLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDckUsSUFBSSxXQUFXLEtBQUksS0FBSyxhQUFMLEtB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QUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxFQUFFO29CQUNqRSxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztpQkFDOUI7YUFDSjtTQUNKO1FBQ0QsSUFBSSxDQUFDLDhCQUE4QixFQUFFLENBQUM7SUFDMUMsQ0FBQztJQUVELFlBQVk7UUFDUixPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDdkQsQ0FBQztJQUVPLDhCQUE4QjtRQUNsQyxJQUFJLENBQUMsdUJBQXVCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUN2RCxDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgU2VsZWN0aW9uTWFuYWdlck9wdGlvbnM8VD4ge1xuICAgIG11bHRpU2VsZWN0OiBib29sZWFuO1xuICAgIGl0ZW1zQXJlRXF1YWw6IChhOiBULCBiOiBUKSA9PiBib29sZWFuO1xuICAgIGFkZGl0aXZlTW9kZTogYm9vbGVhbjtcbn1cblxuLyoqXG4gKiBAZGVzY3JpcHRpb25cbiAqIEEgaGVscGVyIGNsYXNzIHVzZWQgdG8gbWFuYWdlIHNlbGVjdGlvbiBvZiBsaXN0IGl0ZW1zLiBTdXBwb3J0cyBtdWx0aXBsZSBzZWxlY3Rpb24gdmlhXG4gKiBjbWQvY3RybC9zaGlmdCBrZXkuXG4gKi9cbmV4cG9ydCBjbGFzcyBTZWxlY3Rpb25NYW5hZ2VyPFQ+IHtcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIG9wdGlvbnM6IFNlbGVjdGlvbk1hbmFnZXJPcHRpb25zPFQ+KSB7XG4gICAgICAgIHRoaXMuc2VsZWN0aW9uQ2hhbmdlcyQgPSB0aGlzLnNlbGVjdGlvbkNoYW5nZXNTdWJqZWN0LmFzT2JzZXJ2YWJsZSgpO1xuICAgIH1cblxuICAgIGdldCBzZWxlY3Rpb24oKTogVFtdIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3NlbGVjdGlvbjtcbiAgICB9XG5cbiAgICBzZWxlY3Rpb25DaGFuZ2VzJDogT2JzZXJ2YWJsZTxUW10+O1xuXG4gICAgcHJpdmF0ZSBfc2VsZWN0aW9uOiBUW10gPSBbXTtcbiAgICBwcml2YXRlIGl0ZW1zOiBUW10gPSBbXTtcbiAgICBwcml2YXRlIHNlbGVjdGlvbkNoYW5nZXNTdWJqZWN0ID0gbmV3IFN1YmplY3Q8VFtdPigpO1xuXG4gICAgc2V0TXVsdGlTZWxlY3QoaXNNdWx0aVNlbGVjdDogYm9vbGVhbikge1xuICAgICAgICB0aGlzLm9wdGlvbnMubXVsdGlTZWxlY3QgPSBpc011bHRpU2VsZWN0O1xuICAgIH1cblxuICAgIHNldEN1cnJlbnRJdGVtcyhpdGVtczogVFtdKSB7XG4gICAgICAgIHRoaXMuaXRlbXMgPSBpdGVtcztcbiAgICB9XG5cbiAgICB0b2dnbGVTZWxlY3Rpb24oaXRlbTogVCwgZXZlbnQ/OiBNb3VzZUV2ZW50KSB7XG4gICAgICAgIGNvbnN0IHsgbXVsdGlTZWxlY3QsIGl0ZW1zQXJlRXF1YWwsIGFkZGl0aXZlTW9kZSB9ID0gdGhpcy5vcHRpb25zO1xuICAgICAgICBjb25zdCBpbmRleCA9IHRoaXMuX3NlbGVjdGlvbi5maW5kSW5kZXgoYSA9PiBpdGVtc0FyZUVxdWFsKGEsIGl0ZW0pKTtcbiAgICAgICAgaWYgKG11bHRpU2VsZWN0ICYmIGV2ZW50Py5zaGlmdEtleSAmJiAxIDw9IHRoaXMuX3NlbGVjdGlvbi5sZW5ndGgpIHtcbiAgICAgICAgICAgIGNvbnN0IGxhc3RTZWxlY3Rpb24gPSB0aGlzLl9zZWxlY3Rpb25bdGhpcy5fc2VsZWN0aW9uLmxlbmd0aCAtIDFdO1xuICAgICAgICAgICAgY29uc3QgbGFzdFNlbGVjdGlvbkluZGV4ID0gdGhpcy5pdGVtcy5maW5kSW5kZXgoYSA9PiBpdGVtc0FyZUVxdWFsKGEsIGxhc3RTZWxlY3Rpb24pKTtcbiAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRJbmRleCA9IHRoaXMuaXRlbXMuZmluZEluZGV4KGEgPT4gaXRlbXNBcmVFcXVhbChhLCBpdGVtKSk7XG4gICAgICAgICAgICBjb25zdCBzdGFydCA9IGN1cnJlbnRJbmRleCA8IGxhc3RTZWxlY3Rpb25JbmRleCA/IGN1cnJlbnRJbmRleCA6IGxhc3RTZWxlY3Rpb25JbmRleDtcbiAgICAgICAgICAgIGNvbnN0IGVuZCA9IGN1cnJlbnRJbmRleCA+IGxhc3RTZWxlY3Rpb25JbmRleCA/IGN1cnJlbnRJbmRleCArIDEgOiBsYXN0U2VsZWN0aW9uSW5kZXg7XG4gICAgICAgICAgICB0aGlzLl9zZWxlY3Rpb24ucHVzaChcbiAgICAgICAgICAgICAgICAuLi50aGlzLml0ZW1zLnNsaWNlKHN0YXJ0LCBlbmQpLmZpbHRlcihhID0+ICF0aGlzLl9zZWxlY3Rpb24uZmluZChzID0+IGl0ZW1zQXJlRXF1YWwoYSwgcykpKSxcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSBpZiAoaW5kZXggPT09IC0xKSB7XG4gICAgICAgICAgICBpZiAobXVsdGlTZWxlY3QgJiYgKGV2ZW50Py5jdHJsS2V5IHx8IGV2ZW50Py5zaGlmdEtleSB8fCBhZGRpdGl2ZU1vZGUpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fc2VsZWN0aW9uLnB1c2goaXRlbSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuX3NlbGVjdGlvbiA9IFtpdGVtXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChtdWx0aVNlbGVjdCAmJiBldmVudD8uY3RybEtleSkge1xuICAgICAgICAgICAgICAgIHRoaXMuX3NlbGVjdGlvbi5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICAgICAgfSBlbHNlIGlmICgxIDwgdGhpcy5fc2VsZWN0aW9uLmxlbmd0aCAmJiAhYWRkaXRpdmVNb2RlKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fc2VsZWN0aW9uID0gW2l0ZW1dO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9zZWxlY3Rpb24uc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICAvLyBNYWtlIHRoZSBzZWxlY3Rpb24gbXV0YWJsZVxuICAgICAgICB0aGlzLl9zZWxlY3Rpb24gPSB0aGlzLl9zZWxlY3Rpb24ubWFwKHggPT4gKHsgLi4ueCB9KSk7XG4gICAgICAgIHRoaXMuaW52b2tlT25TZWxlY3Rpb25DaGFuZ2VIYW5kbGVyKCk7XG4gICAgfVxuXG4gICAgc2VsZWN0TXVsdGlwbGUoaXRlbXM6IFRbXSkge1xuICAgICAgICB0aGlzLl9zZWxlY3Rpb24gPSBpdGVtcztcbiAgICAgICAgdGhpcy5pbnZva2VPblNlbGVjdGlvbkNoYW5nZUhhbmRsZXIoKTtcbiAgICB9XG5cbiAgICBjbGVhclNlbGVjdGlvbigpIHtcbiAgICAgICAgdGhpcy5fc2VsZWN0aW9uID0gW107XG4gICAgICAgIHRoaXMuaW52b2tlT25TZWxlY3Rpb25DaGFuZ2VIYW5kbGVyKCk7XG4gICAgfVxuXG4gICAgaXNTZWxlY3RlZChpdGVtOiBUKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiAhIXRoaXMuX3NlbGVjdGlvbi5maW5kKGEgPT4gdGhpcy5vcHRpb25zLml0ZW1zQXJlRXF1YWwoYSwgaXRlbSkpO1xuICAgIH1cblxuICAgIGFyZUFsbEN1cnJlbnRJdGVtc1NlbGVjdGVkKCk6IGJvb2xlYW4ge1xuICAgICAgICBpZiAoIXRoaXMuaXRlbXMgfHwgdGhpcy5pdGVtcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5pdGVtcy5ldmVyeShhID0+IHRoaXMuX3NlbGVjdGlvbi5maW5kKGIgPT4gdGhpcy5vcHRpb25zLml0ZW1zQXJlRXF1YWwoYSwgYikpKTtcbiAgICB9XG5cbiAgICB0b2dnbGVTZWxlY3RBbGwoKSB7XG4gICAgICAgIGlmICh0aGlzLmFyZUFsbEN1cnJlbnRJdGVtc1NlbGVjdGVkKCkpIHtcbiAgICAgICAgICAgIHRoaXMuX3NlbGVjdGlvbiA9IHRoaXMuX3NlbGVjdGlvbi5maWx0ZXIoXG4gICAgICAgICAgICAgICAgYSA9PiAhdGhpcy5pdGVtcy5maW5kKGIgPT4gdGhpcy5vcHRpb25zLml0ZW1zQXJlRXF1YWwoYSwgYikpLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuX3NlbGVjdGlvbiA9IHRoaXMuX3NlbGVjdGlvbi5zbGljZSgwKTtcbiAgICAgICAgICAgIGZvciAoY29uc3QgaXRlbSBvZiB0aGlzLml0ZW1zKSB7XG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9zZWxlY3Rpb24uZmluZChhID0+IHRoaXMub3B0aW9ucy5pdGVtc0FyZUVxdWFsKGEsIGl0ZW0pKSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9zZWxlY3Rpb24ucHVzaChpdGVtKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5pbnZva2VPblNlbGVjdGlvbkNoYW5nZUhhbmRsZXIoKTtcbiAgICB9XG5cbiAgICBsYXN0U2VsZWN0ZWQoKTogVCB7XG4gICAgICAgIHJldHVybiB0aGlzLl9zZWxlY3Rpb25bdGhpcy5fc2VsZWN0aW9uLmxlbmd0aCAtIDFdO1xuICAgIH1cblxuICAgIHByaXZhdGUgaW52b2tlT25TZWxlY3Rpb25DaGFuZ2VIYW5kbGVyKCkge1xuICAgICAgICB0aGlzLnNlbGVjdGlvbkNoYW5nZXNTdWJqZWN0Lm5leHQodGhpcy5fc2VsZWN0aW9uKTtcbiAgICB9XG59XG4iXX0=