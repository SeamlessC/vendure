import { toggleMark } from 'prosemirror-commands';
import { redo, undo } from 'prosemirror-history';
import { blockTypeItem, Dropdown, icons, joinUpItem, liftItem, MenuItem, selectParentNodeItem, wrapItem, } from 'prosemirror-menu';
import { wrapInList } from 'prosemirror-schema-list';
import { insertImageItem } from '../plugins/image-plugin';
import { addTable } from '../plugins/tables-plugin';
import { linkItem } from './links';
import { canInsert, IconSize, markActive, renderClarityIcon, wrapInMenuItemWithIcon } from './menu-common';
import { SubMenuWithIcon } from './sub-menu-with-icon';
function cmdItem(cmd, options) {
    const passedOptions = {
        label: options.title,
        run: cmd,
        render: options.iconShape
            ? renderClarityIcon({ shape: options.iconShape, size: IconSize.Large })
            : undefined,
    };
    // tslint:disable-next-line:forin
    for (const prop in options) {
        passedOptions[prop] = options[prop];
    }
    if ((!options.enable || options.enable === true) && !options.select) {
        passedOptions[options.enable ? 'enable' : 'select'] = state => cmd(state);
    }
    return new MenuItem(passedOptions);
}
function markItem(markType, options) {
    const passedOptions = {
        active(state) {
            return markActive(state, markType);
        },
        enable: true,
    };
    // tslint:disable-next-line:forin
    for (const prop in options) {
        passedOptions[prop] = options[prop];
    }
    return cmdItem(toggleMark(markType), passedOptions);
}
function wrapListItem(nodeType, options) {
    return cmdItem(wrapInList(nodeType, options.attrs), options);
}
// :: (Schema) â†’ Object
// Given a schema, look for default mark and node types in it and
// return an object with relevant menu items relating to those marks:
//
// **`toggleStrong`**`: MenuItem`
//   : A menu item to toggle the [strong mark](#schema-basic.StrongMark).
//
// **`toggleEm`**`: MenuItem`
//   : A menu item to toggle the [emphasis mark](#schema-basic.EmMark).
//
// **`toggleCode`**`: MenuItem`
//   : A menu item to toggle the [code font mark](#schema-basic.CodeMark).
//
// **`toggleLink`**`: MenuItem`
//   : A menu item to toggle the [link mark](#schema-basic.LinkMark).
//
// **`insertImage`**`: MenuItem`
//   : A menu item to insert an [image](#schema-basic.Image).
//
// **`wrapBulletList`**`: MenuItem`
//   : A menu item to wrap the selection in a [bullet list](#schema-list.BulletList).
//
// **`wrapOrderedList`**`: MenuItem`
//   : A menu item to wrap the selection in an [ordered list](#schema-list.OrderedList).
//
// **`wrapBlockQuote`**`: MenuItem`
//   : A menu item to wrap the selection in a [block quote](#schema-basic.BlockQuote).
//
// **`makeParagraph`**`: MenuItem`
//   : A menu item to set the current textblock to be a normal
//     [paragraph](#schema-basic.Paragraph).
//
// **`makeCodeBlock`**`: MenuItem`
//   : A menu item to set the current textblock to be a
//     [code block](#schema-basic.CodeBlock).
//
// **`makeHead[N]`**`: MenuItem`
//   : Where _N_ is 1 to 6. Menu items to set the current textblock to
//     be a [heading](#schema-basic.Heading) of level _N_.
//
// **`insertHorizontalRule`**`: MenuItem`
//   : A menu item to insert a horizontal rule.
//
// The return value also contains some prefabricated menu elements and
// menus, that you can use instead of composing your own menu from
// scratch:
//
// **`insertMenu`**`: Dropdown`
//   : A dropdown containing the `insertImage` and
//     `insertHorizontalRule` items.
//
// **`typeMenu`**`: Dropdown`
//   : A dropdown containing the items for making the current
//     textblock a paragraph, code block, or heading.
//
// **`fullMenu`**`: [[MenuElement]]`
//   : An array of arrays of menu elements for use as the full menu
//     for, for example the [menu bar](https://github.com/prosemirror/prosemirror-menu#user-content-menubar).
export function buildMenuItems(schema, modalService) {
    const r = {};
    let type;
    // tslint:disable:no-conditional-assignment
    if ((type = schema.marks.strong)) {
        r.toggleStrong = markItem(type, {
            title: 'Toggle strong style',
            iconShape: 'bold',
        });
    }
    if ((type = schema.marks.em)) {
        r.toggleEm = markItem(type, {
            title: 'Toggle emphasis',
            iconShape: 'italic',
        });
    }
    if ((type = schema.marks.code)) {
        r.toggleCode = markItem(type, { title: 'Toggle code font', icon: icons.code });
    }
    if ((type = schema.marks.link)) {
        r.toggleLink = linkItem(type, modalService);
    }
    if ((type = schema.nodes.image)) {
        r.insertImage = insertImageItem(type, modalService);
    }
    if ((type = schema.nodes.bullet_list)) {
        r.wrapBulletList = wrapListItem(type, {
            title: 'Wrap in bullet list',
            iconShape: 'bullet-list',
        });
    }
    if ((type = schema.nodes.ordered_list)) {
        r.wrapOrderedList = wrapListItem(type, {
            title: 'Wrap in ordered list',
            iconShape: 'number-list',
        });
    }
    if ((type = schema.nodes.blockquote)) {
        r.wrapBlockQuote = wrapItem(type, {
            title: 'Wrap in block quote',
            render: renderClarityIcon({ shape: 'block-quote', size: IconSize.Large }),
        });
    }
    if ((type = schema.nodes.paragraph)) {
        r.makeParagraph = blockTypeItem(type, {
            title: 'Change to paragraph',
            render: renderClarityIcon({ shape: 'text', label: 'Plain' }),
        });
    }
    if ((type = schema.nodes.code_block)) {
        r.makeCodeBlock = blockTypeItem(type, {
            title: 'Change to code block',
            render: renderClarityIcon({ shape: 'code', label: 'Code' }),
        });
    }
    if ((type = schema.nodes.heading)) {
        for (let i = 1; i <= 10; i++) {
            r['makeHead' + i] = blockTypeItem(type, {
                title: 'Change to heading ' + i,
                label: 'Level ' + i,
                attrs: { level: i },
            });
        }
    }
    if ((type = schema.nodes.horizontal_rule)) {
        const hr = type;
        r.insertHorizontalRule = new MenuItem({
            title: 'Insert horizontal rule',
            render: view => {
                const icon = document.createElement('div');
                icon.classList.add('custom-icon', 'hr-icon');
                const labelEl = document.createElement('span');
                labelEl.textContent = 'Horizontal rule';
                return wrapInMenuItemWithIcon(icon, labelEl);
            },
            enable(state) {
                return canInsert(state, hr);
            },
            run(state, dispatch) {
                dispatch(state.tr.replaceSelectionWith(hr.create()));
            },
        });
    }
    const cut = (arr) => arr.filter(x => x);
    r.insertMenu = new Dropdown(cut([
        r.insertImage,
        r.insertHorizontalRule,
        new MenuItem({
            run: (state, dispatch) => {
                addTable(state, dispatch, {
                    rowsCount: 2,
                    colsCount: 2,
                    withHeaderRow: true,
                    cellContent: '',
                });
            },
            render: renderClarityIcon({ shape: 'table', label: 'Table' }),
        }),
    ]), { label: 'Insert' });
    r.typeMenu = new Dropdown(cut([
        r.makeParagraph,
        r.makeCodeBlock,
        r.makeHead1 &&
            new SubMenuWithIcon(cut([r.makeHead1, r.makeHead2, r.makeHead3, r.makeHead4, r.makeHead5, r.makeHead6]), {
                label: 'Heading',
                icon: () => {
                    const icon = document.createElement('div');
                    icon.textContent = 'H';
                    icon.classList.add('custom-icon', 'h-icon');
                    return icon;
                },
            }),
    ]), { label: 'Type...' });
    const inlineMenu = cut([r.toggleStrong, r.toggleEm, r.toggleLink]);
    r.inlineMenu = [inlineMenu];
    r.blockMenu = [
        cut([
            r.wrapBulletList,
            r.wrapOrderedList,
            r.wrapBlockQuote,
            joinUpItem,
            liftItem,
            selectParentNodeItem,
        ]),
    ];
    const undoRedo = [
        new MenuItem({
            title: 'Undo last change',
            run: undo,
            enable(state) {
                return undo(state);
            },
            render: renderClarityIcon({ shape: 'undo', size: IconSize.Large }),
        }),
        new MenuItem({
            title: 'Redo last undone change',
            run: redo,
            enable(state) {
                return redo(state);
            },
            render: renderClarityIcon({ shape: 'redo', size: IconSize.Large }),
        }),
    ];
    r.fullMenu = [inlineMenu].concat([[r.insertMenu, r.typeMenu]], [undoRedo], r.blockMenu);
    return r;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVudS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3NyYy9saWIvY29yZS9zcmMvc2hhcmVkL2NvbXBvbmVudHMvcmljaC10ZXh0LWVkaXRvci9wcm9zZW1pcnJvci9tZW51L21lbnUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDakQsT0FBTyxFQUNILGFBQWEsRUFDYixRQUFRLEVBQ1IsS0FBSyxFQUNMLFVBQVUsRUFDVixRQUFRLEVBQ1IsUUFBUSxFQUNSLG9CQUFvQixFQUNwQixRQUFRLEdBQ1gsTUFBTSxrQkFBa0IsQ0FBQztBQUUxQixPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFJckQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzFELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUVwRCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ25DLE9BQU8sRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRSxpQkFBaUIsRUFBRSxzQkFBc0IsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzRyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFNdkQsU0FBUyxPQUFPLENBQUMsR0FBNkIsRUFBRSxPQUF1QjtJQUNuRSxNQUFNLGFBQWEsR0FBRztRQUNsQixLQUFLLEVBQUUsT0FBTyxDQUFDLEtBQUs7UUFDcEIsR0FBRyxFQUFFLEdBQUc7UUFDUixNQUFNLEVBQUUsT0FBTyxDQUFDLFNBQVM7WUFDckIsQ0FBQyxDQUFDLGlCQUFpQixDQUFDLEVBQUUsS0FBSyxFQUFFLE9BQU8sQ0FBQyxTQUFTLEVBQUUsSUFBSSxFQUFFLFFBQVEsQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUN2RSxDQUFDLENBQUMsU0FBUztLQUNsQixDQUFDO0lBQ0YsaUNBQWlDO0lBQ2pDLEtBQUssTUFBTSxJQUFJLElBQUksT0FBTyxFQUFFO1FBQ3hCLGFBQWEsQ0FBQyxJQUFJLENBQUMsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7S0FDdkM7SUFDRCxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxJQUFJLE9BQU8sQ0FBQyxNQUFNLEtBQUssSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFO1FBQ2pFLGFBQWEsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxHQUFHLEtBQUssQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO0tBQzdFO0lBRUQsT0FBTyxJQUFJLFFBQVEsQ0FBQyxhQUFvQixDQUFDLENBQUM7QUFDOUMsQ0FBQztBQUVELFNBQVMsUUFBUSxDQUFDLFFBQVEsRUFBRSxPQUF1QjtJQUMvQyxNQUFNLGFBQWEsR0FBRztRQUNsQixNQUFNLENBQUMsS0FBSztZQUNSLE9BQU8sVUFBVSxDQUFDLEtBQUssRUFBRSxRQUFRLENBQUMsQ0FBQztRQUN2QyxDQUFDO1FBQ0QsTUFBTSxFQUFFLElBQUk7S0FDZixDQUFDO0lBQ0YsaUNBQWlDO0lBQ2pDLEtBQUssTUFBTSxJQUFJLElBQUksT0FBTyxFQUFFO1FBQ3hCLGFBQWEsQ0FBQyxJQUFJLENBQUMsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7S0FDdkM7SUFDRCxPQUFPLE9BQU8sQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLEVBQUUsYUFBYSxDQUFDLENBQUM7QUFDeEQsQ0FBQztBQUVELFNBQVMsWUFBWSxDQUFDLFFBQVEsRUFBRSxPQUF1QjtJQUNuRCxPQUFPLE9BQU8sQ0FBQyxVQUFVLENBQUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxLQUFLLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQztBQUNqRSxDQUFDO0FBRUQsdUJBQXVCO0FBQ3ZCLGlFQUFpRTtBQUNqRSxxRUFBcUU7QUFDckUsRUFBRTtBQUNGLGlDQUFpQztBQUNqQyx5RUFBeUU7QUFDekUsRUFBRTtBQUNGLDZCQUE2QjtBQUM3Qix1RUFBdUU7QUFDdkUsRUFBRTtBQUNGLCtCQUErQjtBQUMvQiwwRUFBMEU7QUFDMUUsRUFBRTtBQUNGLCtCQUErQjtBQUMvQixxRUFBcUU7QUFDckUsRUFBRTtBQUNGLGdDQUFnQztBQUNoQyw2REFBNkQ7QUFDN0QsRUFBRTtBQUNGLG1DQUFtQztBQUNuQyxxRkFBcUY7QUFDckYsRUFBRTtBQUNGLG9DQUFvQztBQUNwQyx3RkFBd0Y7QUFDeEYsRUFBRTtBQUNGLG1DQUFtQztBQUNuQyxzRkFBc0Y7QUFDdEYsRUFBRTtBQUNGLGtDQUFrQztBQUNsQyw4REFBOEQ7QUFDOUQsNENBQTRDO0FBQzVDLEVBQUU7QUFDRixrQ0FBa0M7QUFDbEMsdURBQXVEO0FBQ3ZELDZDQUE2QztBQUM3QyxFQUFFO0FBQ0YsZ0NBQWdDO0FBQ2hDLHNFQUFzRTtBQUN0RSwwREFBMEQ7QUFDMUQsRUFBRTtBQUNGLHlDQUF5QztBQUN6QywrQ0FBK0M7QUFDL0MsRUFBRTtBQUNGLHNFQUFzRTtBQUN0RSxrRUFBa0U7QUFDbEUsV0FBVztBQUNYLEVBQUU7QUFDRiwrQkFBK0I7QUFDL0Isa0RBQWtEO0FBQ2xELG9DQUFvQztBQUNwQyxFQUFFO0FBQ0YsNkJBQTZCO0FBQzdCLDZEQUE2RDtBQUM3RCxxREFBcUQ7QUFDckQsRUFBRTtBQUNGLG9DQUFvQztBQUNwQyxtRUFBbUU7QUFDbkUsNkdBQTZHO0FBQzdHLE1BQU0sVUFBVSxjQUFjLENBQUMsTUFBYyxFQUFFLFlBQTBCO0lBQ3JFLE1BQU0sQ0FBQyxHQUF3QixFQUFFLENBQUM7SUFDbEMsSUFBSSxJQUF5QixDQUFDO0lBQzlCLDJDQUEyQztJQUMzQyxJQUFJLENBQUMsSUFBSSxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEVBQUU7UUFDOUIsQ0FBQyxDQUFDLFlBQVksR0FBRyxRQUFRLENBQUMsSUFBSSxFQUFFO1lBQzVCLEtBQUssRUFBRSxxQkFBcUI7WUFDNUIsU0FBUyxFQUFFLE1BQU07U0FDcEIsQ0FBQyxDQUFDO0tBQ047SUFDRCxJQUFJLENBQUMsSUFBSSxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEVBQUU7UUFDMUIsQ0FBQyxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUMsSUFBSSxFQUFFO1lBQ3hCLEtBQUssRUFBRSxpQkFBaUI7WUFDeEIsU0FBUyxFQUFFLFFBQVE7U0FDdEIsQ0FBQyxDQUFDO0tBQ047SUFDRCxJQUFJLENBQUMsSUFBSSxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUU7UUFDNUIsQ0FBQyxDQUFDLFVBQVUsR0FBRyxRQUFRLENBQUMsSUFBSSxFQUFFLEVBQUUsS0FBSyxFQUFFLGtCQUFrQixFQUFFLElBQUksRUFBRSxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztLQUNsRjtJQUNELElBQUksQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBRTtRQUM1QixDQUFDLENBQUMsVUFBVSxHQUFHLFFBQVEsQ0FBQyxJQUFJLEVBQUUsWUFBWSxDQUFDLENBQUM7S0FDL0M7SUFFRCxJQUFJLENBQUMsSUFBSSxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUU7UUFDN0IsQ0FBQyxDQUFDLFdBQVcsR0FBRyxlQUFlLENBQUMsSUFBSSxFQUFFLFlBQVksQ0FBQyxDQUFDO0tBQ3ZEO0lBQ0QsSUFBSSxDQUFDLElBQUksR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxFQUFFO1FBQ25DLENBQUMsQ0FBQyxjQUFjLEdBQUcsWUFBWSxDQUFDLElBQUksRUFBRTtZQUNsQyxLQUFLLEVBQUUscUJBQXFCO1lBQzVCLFNBQVMsRUFBRSxhQUFhO1NBQzNCLENBQUMsQ0FBQztLQUNOO0lBQ0QsSUFBSSxDQUFDLElBQUksR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxFQUFFO1FBQ3BDLENBQUMsQ0FBQyxlQUFlLEdBQUcsWUFBWSxDQUFDLElBQUksRUFBRTtZQUNuQyxLQUFLLEVBQUUsc0JBQXNCO1lBQzdCLFNBQVMsRUFBRSxhQUFhO1NBQzNCLENBQUMsQ0FBQztLQUNOO0lBQ0QsSUFBSSxDQUFDLElBQUksR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxFQUFFO1FBQ2xDLENBQUMsQ0FBQyxjQUFjLEdBQUcsUUFBUSxDQUFDLElBQUksRUFBRTtZQUM5QixLQUFLLEVBQUUscUJBQXFCO1lBQzVCLE1BQU0sRUFBRSxpQkFBaUIsQ0FBQyxFQUFFLEtBQUssRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFFLFFBQVEsQ0FBQyxLQUFLLEVBQUUsQ0FBQztTQUM1RSxDQUFDLENBQUM7S0FDTjtJQUNELElBQUksQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsRUFBRTtRQUNqQyxDQUFDLENBQUMsYUFBYSxHQUFHLGFBQWEsQ0FBQyxJQUFJLEVBQUU7WUFDbEMsS0FBSyxFQUFFLHFCQUFxQjtZQUM1QixNQUFNLEVBQUUsaUJBQWlCLENBQUMsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsQ0FBQztTQUMvRCxDQUFDLENBQUM7S0FDTjtJQUNELElBQUksQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsRUFBRTtRQUNsQyxDQUFDLENBQUMsYUFBYSxHQUFHLGFBQWEsQ0FBQyxJQUFJLEVBQUU7WUFDbEMsS0FBSyxFQUFFLHNCQUFzQjtZQUM3QixNQUFNLEVBQUUsaUJBQWlCLENBQUMsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsQ0FBQztTQUM5RCxDQUFDLENBQUM7S0FDTjtJQUNELElBQUksQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsRUFBRTtRQUMvQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQzFCLENBQUMsQ0FBQyxVQUFVLEdBQUcsQ0FBQyxDQUFDLEdBQUcsYUFBYSxDQUFDLElBQUksRUFBRTtnQkFDcEMsS0FBSyxFQUFFLG9CQUFvQixHQUFHLENBQUM7Z0JBQy9CLEtBQUssRUFBRSxRQUFRLEdBQUcsQ0FBQztnQkFDbkIsS0FBSyxFQUFFLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRTthQUN0QixDQUFDLENBQUM7U0FDTjtLQUNKO0lBQ0QsSUFBSSxDQUFDLElBQUksR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLGVBQWUsQ0FBQyxFQUFFO1FBQ3ZDLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQztRQUNoQixDQUFDLENBQUMsb0JBQW9CLEdBQUcsSUFBSSxRQUFRLENBQUM7WUFDbEMsS0FBSyxFQUFFLHdCQUF3QjtZQUMvQixNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUU7Z0JBQ1gsTUFBTSxJQUFJLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDM0MsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsYUFBYSxFQUFFLFNBQVMsQ0FBQyxDQUFDO2dCQUM3QyxNQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUMvQyxPQUFPLENBQUMsV0FBVyxHQUFHLGlCQUFpQixDQUFDO2dCQUN4QyxPQUFPLHNCQUFzQixDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztZQUNqRCxDQUFDO1lBQ0QsTUFBTSxDQUFDLEtBQUs7Z0JBQ1IsT0FBTyxTQUFTLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQ2hDLENBQUM7WUFDRCxHQUFHLENBQUMsS0FBa0IsRUFBRSxRQUFRO2dCQUM1QixRQUFRLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxvQkFBb0IsQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ3pELENBQUM7U0FDSixDQUFDLENBQUM7S0FDTjtJQUVELE1BQU0sR0FBRyxHQUFHLENBQUksR0FBUSxFQUFPLEVBQUUsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDckQsQ0FBQyxDQUFDLFVBQVUsR0FBRyxJQUFJLFFBQVEsQ0FDdkIsR0FBRyxDQUFDO1FBQ0EsQ0FBQyxDQUFDLFdBQVc7UUFDYixDQUFDLENBQUMsb0JBQW9CO1FBQ3RCLElBQUksUUFBUSxDQUFDO1lBQ1QsR0FBRyxFQUFFLENBQUMsS0FBSyxFQUFFLFFBQVEsRUFBRSxFQUFFO2dCQUNyQixRQUFRLENBQUMsS0FBSyxFQUFFLFFBQVEsRUFBRTtvQkFDdEIsU0FBUyxFQUFFLENBQUM7b0JBQ1osU0FBUyxFQUFFLENBQUM7b0JBQ1osYUFBYSxFQUFFLElBQUk7b0JBQ25CLFdBQVcsRUFBRSxFQUFFO2lCQUNsQixDQUFDLENBQUM7WUFDUCxDQUFDO1lBQ0QsTUFBTSxFQUFFLGlCQUFpQixDQUFDLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLENBQUM7U0FDaEUsQ0FBQztLQUNMLENBQUMsRUFDRixFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsQ0FDdEIsQ0FBQztJQUNGLENBQUMsQ0FBQyxRQUFRLEdBQUcsSUFBSSxRQUFRLENBQ3JCLEdBQUcsQ0FBQztRQUNBLENBQUMsQ0FBQyxhQUFhO1FBQ2YsQ0FBQyxDQUFDLGFBQWE7UUFDZixDQUFDLENBQUMsU0FBUztZQUNQLElBQUksZUFBZSxDQUNmLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsRUFDbkY7Z0JBQ0ksS0FBSyxFQUFFLFNBQVM7Z0JBQ2hCLElBQUksRUFBRSxHQUFHLEVBQUU7b0JBQ1AsTUFBTSxJQUFJLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztvQkFDM0MsSUFBSSxDQUFDLFdBQVcsR0FBRyxHQUFHLENBQUM7b0JBQ3ZCLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxRQUFRLENBQUMsQ0FBQztvQkFDNUMsT0FBTyxJQUFJLENBQUM7Z0JBQ2hCLENBQUM7YUFDSixDQUNKO0tBQ1IsQ0FBQyxFQUNGLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxDQUN2QixDQUFDO0lBRUYsTUFBTSxVQUFVLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLFlBQVksRUFBRSxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO0lBQ25FLENBQUMsQ0FBQyxVQUFVLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUM1QixDQUFDLENBQUMsU0FBUyxHQUFHO1FBQ1YsR0FBRyxDQUFDO1lBQ0EsQ0FBQyxDQUFDLGNBQWM7WUFDaEIsQ0FBQyxDQUFDLGVBQWU7WUFDakIsQ0FBQyxDQUFDLGNBQWM7WUFDaEIsVUFBVTtZQUNWLFFBQVE7WUFDUixvQkFBb0I7U0FDdkIsQ0FBQztLQUNMLENBQUM7SUFDRixNQUFNLFFBQVEsR0FBRztRQUNiLElBQUksUUFBUSxDQUFDO1lBQ1QsS0FBSyxFQUFFLGtCQUFrQjtZQUN6QixHQUFHLEVBQUUsSUFBSTtZQUNULE1BQU0sQ0FBQyxLQUFLO2dCQUNSLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3ZCLENBQUM7WUFDRCxNQUFNLEVBQUUsaUJBQWlCLENBQUMsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxRQUFRLENBQUMsS0FBSyxFQUFFLENBQUM7U0FDckUsQ0FBQztRQUNGLElBQUksUUFBUSxDQUFDO1lBQ1QsS0FBSyxFQUFFLHlCQUF5QjtZQUNoQyxHQUFHLEVBQUUsSUFBSTtZQUNULE1BQU0sQ0FBQyxLQUFLO2dCQUNSLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3ZCLENBQUM7WUFDRCxNQUFNLEVBQUUsaUJBQWlCLENBQUMsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxRQUFRLENBQUMsS0FBSyxFQUFFLENBQUM7U0FDckUsQ0FBQztLQUNMLENBQUM7SUFDRixDQUFDLENBQUMsUUFBUSxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBRXhGLE9BQU8sQ0FBQyxDQUFDO0FBQ2IsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHRvZ2dsZU1hcmsgfSBmcm9tICdwcm9zZW1pcnJvci1jb21tYW5kcyc7XG5pbXBvcnQgeyByZWRvLCB1bmRvIH0gZnJvbSAncHJvc2VtaXJyb3ItaGlzdG9yeSc7XG5pbXBvcnQge1xuICAgIGJsb2NrVHlwZUl0ZW0sXG4gICAgRHJvcGRvd24sXG4gICAgaWNvbnMsXG4gICAgam9pblVwSXRlbSxcbiAgICBsaWZ0SXRlbSxcbiAgICBNZW51SXRlbSxcbiAgICBzZWxlY3RQYXJlbnROb2RlSXRlbSxcbiAgICB3cmFwSXRlbSxcbn0gZnJvbSAncHJvc2VtaXJyb3ItbWVudSc7XG5pbXBvcnQgeyBNYXJrVHlwZSwgTm9kZVR5cGUsIFNjaGVtYSB9IGZyb20gJ3Byb3NlbWlycm9yLW1vZGVsJztcbmltcG9ydCB7IHdyYXBJbkxpc3QgfSBmcm9tICdwcm9zZW1pcnJvci1zY2hlbWEtbGlzdCc7XG5pbXBvcnQgeyBFZGl0b3JTdGF0ZSB9IGZyb20gJ3Byb3NlbWlycm9yLXN0YXRlJztcblxuaW1wb3J0IHsgTW9kYWxTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vcHJvdmlkZXJzL21vZGFsL21vZGFsLnNlcnZpY2UnO1xuaW1wb3J0IHsgaW5zZXJ0SW1hZ2VJdGVtIH0gZnJvbSAnLi4vcGx1Z2lucy9pbWFnZS1wbHVnaW4nO1xuaW1wb3J0IHsgYWRkVGFibGUgfSBmcm9tICcuLi9wbHVnaW5zL3RhYmxlcy1wbHVnaW4nO1xuXG5pbXBvcnQgeyBsaW5rSXRlbSB9IGZyb20gJy4vbGlua3MnO1xuaW1wb3J0IHsgY2FuSW5zZXJ0LCBJY29uU2l6ZSwgbWFya0FjdGl2ZSwgcmVuZGVyQ2xhcml0eUljb24sIHdyYXBJbk1lbnVJdGVtV2l0aEljb24gfSBmcm9tICcuL21lbnUtY29tbW9uJztcbmltcG9ydCB7IFN1Yk1lbnVXaXRoSWNvbiB9IGZyb20gJy4vc3ViLW1lbnUtd2l0aC1pY29uJztcblxuLy8gSGVscGVycyB0byBjcmVhdGUgc3BlY2lmaWMgdHlwZXMgb2YgaXRlbXNcblxudHlwZSBDbWRJdGVtT3B0aW9ucyA9IFJlY29yZDxzdHJpbmcsIGFueT4gJiB7IGljb25TaGFwZT86IHN0cmluZyB9O1xuXG5mdW5jdGlvbiBjbWRJdGVtKGNtZDogKC4uLmFyZ3M6IGFueVtdKSA9PiB2b2lkLCBvcHRpb25zOiBDbWRJdGVtT3B0aW9ucykge1xuICAgIGNvbnN0IHBhc3NlZE9wdGlvbnMgPSB7XG4gICAgICAgIGxhYmVsOiBvcHRpb25zLnRpdGxlLFxuICAgICAgICBydW46IGNtZCxcbiAgICAgICAgcmVuZGVyOiBvcHRpb25zLmljb25TaGFwZVxuICAgICAgICAgICAgPyByZW5kZXJDbGFyaXR5SWNvbih7IHNoYXBlOiBvcHRpb25zLmljb25TaGFwZSwgc2l6ZTogSWNvblNpemUuTGFyZ2UgfSlcbiAgICAgICAgICAgIDogdW5kZWZpbmVkLFxuICAgIH07XG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOmZvcmluXG4gICAgZm9yIChjb25zdCBwcm9wIGluIG9wdGlvbnMpIHtcbiAgICAgICAgcGFzc2VkT3B0aW9uc1twcm9wXSA9IG9wdGlvbnNbcHJvcF07XG4gICAgfVxuICAgIGlmICgoIW9wdGlvbnMuZW5hYmxlIHx8IG9wdGlvbnMuZW5hYmxlID09PSB0cnVlKSAmJiAhb3B0aW9ucy5zZWxlY3QpIHtcbiAgICAgICAgcGFzc2VkT3B0aW9uc1tvcHRpb25zLmVuYWJsZSA/ICdlbmFibGUnIDogJ3NlbGVjdCddID0gc3RhdGUgPT4gY21kKHN0YXRlKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbmV3IE1lbnVJdGVtKHBhc3NlZE9wdGlvbnMgYXMgYW55KTtcbn1cblxuZnVuY3Rpb24gbWFya0l0ZW0obWFya1R5cGUsIG9wdGlvbnM6IENtZEl0ZW1PcHRpb25zKSB7XG4gICAgY29uc3QgcGFzc2VkT3B0aW9ucyA9IHtcbiAgICAgICAgYWN0aXZlKHN0YXRlKSB7XG4gICAgICAgICAgICByZXR1cm4gbWFya0FjdGl2ZShzdGF0ZSwgbWFya1R5cGUpO1xuICAgICAgICB9LFxuICAgICAgICBlbmFibGU6IHRydWUsXG4gICAgfTtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6Zm9yaW5cbiAgICBmb3IgKGNvbnN0IHByb3AgaW4gb3B0aW9ucykge1xuICAgICAgICBwYXNzZWRPcHRpb25zW3Byb3BdID0gb3B0aW9uc1twcm9wXTtcbiAgICB9XG4gICAgcmV0dXJuIGNtZEl0ZW0odG9nZ2xlTWFyayhtYXJrVHlwZSksIHBhc3NlZE9wdGlvbnMpO1xufVxuXG5mdW5jdGlvbiB3cmFwTGlzdEl0ZW0obm9kZVR5cGUsIG9wdGlvbnM6IENtZEl0ZW1PcHRpb25zKSB7XG4gICAgcmV0dXJuIGNtZEl0ZW0od3JhcEluTGlzdChub2RlVHlwZSwgb3B0aW9ucy5hdHRycyksIG9wdGlvbnMpO1xufVxuXG4vLyA6OiAoU2NoZW1hKSDihpIgT2JqZWN0XG4vLyBHaXZlbiBhIHNjaGVtYSwgbG9vayBmb3IgZGVmYXVsdCBtYXJrIGFuZCBub2RlIHR5cGVzIGluIGl0IGFuZFxuLy8gcmV0dXJuIGFuIG9iamVjdCB3aXRoIHJlbGV2YW50IG1lbnUgaXRlbXMgcmVsYXRpbmcgdG8gdGhvc2UgbWFya3M6XG4vL1xuLy8gKipgdG9nZ2xlU3Ryb25nYCoqYDogTWVudUl0ZW1gXG4vLyAgIDogQSBtZW51IGl0ZW0gdG8gdG9nZ2xlIHRoZSBbc3Ryb25nIG1hcmtdKCNzY2hlbWEtYmFzaWMuU3Ryb25nTWFyaykuXG4vL1xuLy8gKipgdG9nZ2xlRW1gKipgOiBNZW51SXRlbWBcbi8vICAgOiBBIG1lbnUgaXRlbSB0byB0b2dnbGUgdGhlIFtlbXBoYXNpcyBtYXJrXSgjc2NoZW1hLWJhc2ljLkVtTWFyaykuXG4vL1xuLy8gKipgdG9nZ2xlQ29kZWAqKmA6IE1lbnVJdGVtYFxuLy8gICA6IEEgbWVudSBpdGVtIHRvIHRvZ2dsZSB0aGUgW2NvZGUgZm9udCBtYXJrXSgjc2NoZW1hLWJhc2ljLkNvZGVNYXJrKS5cbi8vXG4vLyAqKmB0b2dnbGVMaW5rYCoqYDogTWVudUl0ZW1gXG4vLyAgIDogQSBtZW51IGl0ZW0gdG8gdG9nZ2xlIHRoZSBbbGluayBtYXJrXSgjc2NoZW1hLWJhc2ljLkxpbmtNYXJrKS5cbi8vXG4vLyAqKmBpbnNlcnRJbWFnZWAqKmA6IE1lbnVJdGVtYFxuLy8gICA6IEEgbWVudSBpdGVtIHRvIGluc2VydCBhbiBbaW1hZ2VdKCNzY2hlbWEtYmFzaWMuSW1hZ2UpLlxuLy9cbi8vICoqYHdyYXBCdWxsZXRMaXN0YCoqYDogTWVudUl0ZW1gXG4vLyAgIDogQSBtZW51IGl0ZW0gdG8gd3JhcCB0aGUgc2VsZWN0aW9uIGluIGEgW2J1bGxldCBsaXN0XSgjc2NoZW1hLWxpc3QuQnVsbGV0TGlzdCkuXG4vL1xuLy8gKipgd3JhcE9yZGVyZWRMaXN0YCoqYDogTWVudUl0ZW1gXG4vLyAgIDogQSBtZW51IGl0ZW0gdG8gd3JhcCB0aGUgc2VsZWN0aW9uIGluIGFuIFtvcmRlcmVkIGxpc3RdKCNzY2hlbWEtbGlzdC5PcmRlcmVkTGlzdCkuXG4vL1xuLy8gKipgd3JhcEJsb2NrUXVvdGVgKipgOiBNZW51SXRlbWBcbi8vICAgOiBBIG1lbnUgaXRlbSB0byB3cmFwIHRoZSBzZWxlY3Rpb24gaW4gYSBbYmxvY2sgcXVvdGVdKCNzY2hlbWEtYmFzaWMuQmxvY2tRdW90ZSkuXG4vL1xuLy8gKipgbWFrZVBhcmFncmFwaGAqKmA6IE1lbnVJdGVtYFxuLy8gICA6IEEgbWVudSBpdGVtIHRvIHNldCB0aGUgY3VycmVudCB0ZXh0YmxvY2sgdG8gYmUgYSBub3JtYWxcbi8vICAgICBbcGFyYWdyYXBoXSgjc2NoZW1hLWJhc2ljLlBhcmFncmFwaCkuXG4vL1xuLy8gKipgbWFrZUNvZGVCbG9ja2AqKmA6IE1lbnVJdGVtYFxuLy8gICA6IEEgbWVudSBpdGVtIHRvIHNldCB0aGUgY3VycmVudCB0ZXh0YmxvY2sgdG8gYmUgYVxuLy8gICAgIFtjb2RlIGJsb2NrXSgjc2NoZW1hLWJhc2ljLkNvZGVCbG9jaykuXG4vL1xuLy8gKipgbWFrZUhlYWRbTl1gKipgOiBNZW51SXRlbWBcbi8vICAgOiBXaGVyZSBfTl8gaXMgMSB0byA2LiBNZW51IGl0ZW1zIHRvIHNldCB0aGUgY3VycmVudCB0ZXh0YmxvY2sgdG9cbi8vICAgICBiZSBhIFtoZWFkaW5nXSgjc2NoZW1hLWJhc2ljLkhlYWRpbmcpIG9mIGxldmVsIF9OXy5cbi8vXG4vLyAqKmBpbnNlcnRIb3Jpem9udGFsUnVsZWAqKmA6IE1lbnVJdGVtYFxuLy8gICA6IEEgbWVudSBpdGVtIHRvIGluc2VydCBhIGhvcml6b250YWwgcnVsZS5cbi8vXG4vLyBUaGUgcmV0dXJuIHZhbHVlIGFsc28gY29udGFpbnMgc29tZSBwcmVmYWJyaWNhdGVkIG1lbnUgZWxlbWVudHMgYW5kXG4vLyBtZW51cywgdGhhdCB5b3UgY2FuIHVzZSBpbnN0ZWFkIG9mIGNvbXBvc2luZyB5b3VyIG93biBtZW51IGZyb21cbi8vIHNjcmF0Y2g6XG4vL1xuLy8gKipgaW5zZXJ0TWVudWAqKmA6IERyb3Bkb3duYFxuLy8gICA6IEEgZHJvcGRvd24gY29udGFpbmluZyB0aGUgYGluc2VydEltYWdlYCBhbmRcbi8vICAgICBgaW5zZXJ0SG9yaXpvbnRhbFJ1bGVgIGl0ZW1zLlxuLy9cbi8vICoqYHR5cGVNZW51YCoqYDogRHJvcGRvd25gXG4vLyAgIDogQSBkcm9wZG93biBjb250YWluaW5nIHRoZSBpdGVtcyBmb3IgbWFraW5nIHRoZSBjdXJyZW50XG4vLyAgICAgdGV4dGJsb2NrIGEgcGFyYWdyYXBoLCBjb2RlIGJsb2NrLCBvciBoZWFkaW5nLlxuLy9cbi8vICoqYGZ1bGxNZW51YCoqYDogW1tNZW51RWxlbWVudF1dYFxuLy8gICA6IEFuIGFycmF5IG9mIGFycmF5cyBvZiBtZW51IGVsZW1lbnRzIGZvciB1c2UgYXMgdGhlIGZ1bGwgbWVudVxuLy8gICAgIGZvciwgZm9yIGV4YW1wbGUgdGhlIFttZW51IGJhcl0oaHR0cHM6Ly9naXRodWIuY29tL3Byb3NlbWlycm9yL3Byb3NlbWlycm9yLW1lbnUjdXNlci1jb250ZW50LW1lbnViYXIpLlxuZXhwb3J0IGZ1bmN0aW9uIGJ1aWxkTWVudUl0ZW1zKHNjaGVtYTogU2NoZW1hLCBtb2RhbFNlcnZpY2U6IE1vZGFsU2VydmljZSkge1xuICAgIGNvbnN0IHI6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7fTtcbiAgICBsZXQgdHlwZTogTWFya1R5cGUgfCBOb2RlVHlwZTtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZTpuby1jb25kaXRpb25hbC1hc3NpZ25tZW50XG4gICAgaWYgKCh0eXBlID0gc2NoZW1hLm1hcmtzLnN0cm9uZykpIHtcbiAgICAgICAgci50b2dnbGVTdHJvbmcgPSBtYXJrSXRlbSh0eXBlLCB7XG4gICAgICAgICAgICB0aXRsZTogJ1RvZ2dsZSBzdHJvbmcgc3R5bGUnLFxuICAgICAgICAgICAgaWNvblNoYXBlOiAnYm9sZCcsXG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBpZiAoKHR5cGUgPSBzY2hlbWEubWFya3MuZW0pKSB7XG4gICAgICAgIHIudG9nZ2xlRW0gPSBtYXJrSXRlbSh0eXBlLCB7XG4gICAgICAgICAgICB0aXRsZTogJ1RvZ2dsZSBlbXBoYXNpcycsXG4gICAgICAgICAgICBpY29uU2hhcGU6ICdpdGFsaWMnLFxuICAgICAgICB9KTtcbiAgICB9XG4gICAgaWYgKCh0eXBlID0gc2NoZW1hLm1hcmtzLmNvZGUpKSB7XG4gICAgICAgIHIudG9nZ2xlQ29kZSA9IG1hcmtJdGVtKHR5cGUsIHsgdGl0bGU6ICdUb2dnbGUgY29kZSBmb250JywgaWNvbjogaWNvbnMuY29kZSB9KTtcbiAgICB9XG4gICAgaWYgKCh0eXBlID0gc2NoZW1hLm1hcmtzLmxpbmspKSB7XG4gICAgICAgIHIudG9nZ2xlTGluayA9IGxpbmtJdGVtKHR5cGUsIG1vZGFsU2VydmljZSk7XG4gICAgfVxuXG4gICAgaWYgKCh0eXBlID0gc2NoZW1hLm5vZGVzLmltYWdlKSkge1xuICAgICAgICByLmluc2VydEltYWdlID0gaW5zZXJ0SW1hZ2VJdGVtKHR5cGUsIG1vZGFsU2VydmljZSk7XG4gICAgfVxuICAgIGlmICgodHlwZSA9IHNjaGVtYS5ub2Rlcy5idWxsZXRfbGlzdCkpIHtcbiAgICAgICAgci53cmFwQnVsbGV0TGlzdCA9IHdyYXBMaXN0SXRlbSh0eXBlLCB7XG4gICAgICAgICAgICB0aXRsZTogJ1dyYXAgaW4gYnVsbGV0IGxpc3QnLFxuICAgICAgICAgICAgaWNvblNoYXBlOiAnYnVsbGV0LWxpc3QnLFxuICAgICAgICB9KTtcbiAgICB9XG4gICAgaWYgKCh0eXBlID0gc2NoZW1hLm5vZGVzLm9yZGVyZWRfbGlzdCkpIHtcbiAgICAgICAgci53cmFwT3JkZXJlZExpc3QgPSB3cmFwTGlzdEl0ZW0odHlwZSwge1xuICAgICAgICAgICAgdGl0bGU6ICdXcmFwIGluIG9yZGVyZWQgbGlzdCcsXG4gICAgICAgICAgICBpY29uU2hhcGU6ICdudW1iZXItbGlzdCcsXG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBpZiAoKHR5cGUgPSBzY2hlbWEubm9kZXMuYmxvY2txdW90ZSkpIHtcbiAgICAgICAgci53cmFwQmxvY2tRdW90ZSA9IHdyYXBJdGVtKHR5cGUsIHtcbiAgICAgICAgICAgIHRpdGxlOiAnV3JhcCBpbiBibG9jayBxdW90ZScsXG4gICAgICAgICAgICByZW5kZXI6IHJlbmRlckNsYXJpdHlJY29uKHsgc2hhcGU6ICdibG9jay1xdW90ZScsIHNpemU6IEljb25TaXplLkxhcmdlIH0pLFxuICAgICAgICB9KTtcbiAgICB9XG4gICAgaWYgKCh0eXBlID0gc2NoZW1hLm5vZGVzLnBhcmFncmFwaCkpIHtcbiAgICAgICAgci5tYWtlUGFyYWdyYXBoID0gYmxvY2tUeXBlSXRlbSh0eXBlLCB7XG4gICAgICAgICAgICB0aXRsZTogJ0NoYW5nZSB0byBwYXJhZ3JhcGgnLFxuICAgICAgICAgICAgcmVuZGVyOiByZW5kZXJDbGFyaXR5SWNvbih7IHNoYXBlOiAndGV4dCcsIGxhYmVsOiAnUGxhaW4nIH0pLFxuICAgICAgICB9KTtcbiAgICB9XG4gICAgaWYgKCh0eXBlID0gc2NoZW1hLm5vZGVzLmNvZGVfYmxvY2spKSB7XG4gICAgICAgIHIubWFrZUNvZGVCbG9jayA9IGJsb2NrVHlwZUl0ZW0odHlwZSwge1xuICAgICAgICAgICAgdGl0bGU6ICdDaGFuZ2UgdG8gY29kZSBibG9jaycsXG4gICAgICAgICAgICByZW5kZXI6IHJlbmRlckNsYXJpdHlJY29uKHsgc2hhcGU6ICdjb2RlJywgbGFiZWw6ICdDb2RlJyB9KSxcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGlmICgodHlwZSA9IHNjaGVtYS5ub2Rlcy5oZWFkaW5nKSkge1xuICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8PSAxMDsgaSsrKSB7XG4gICAgICAgICAgICByWydtYWtlSGVhZCcgKyBpXSA9IGJsb2NrVHlwZUl0ZW0odHlwZSwge1xuICAgICAgICAgICAgICAgIHRpdGxlOiAnQ2hhbmdlIHRvIGhlYWRpbmcgJyArIGksXG4gICAgICAgICAgICAgICAgbGFiZWw6ICdMZXZlbCAnICsgaSxcbiAgICAgICAgICAgICAgICBhdHRyczogeyBsZXZlbDogaSB9LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKCh0eXBlID0gc2NoZW1hLm5vZGVzLmhvcml6b250YWxfcnVsZSkpIHtcbiAgICAgICAgY29uc3QgaHIgPSB0eXBlO1xuICAgICAgICByLmluc2VydEhvcml6b250YWxSdWxlID0gbmV3IE1lbnVJdGVtKHtcbiAgICAgICAgICAgIHRpdGxlOiAnSW5zZXJ0IGhvcml6b250YWwgcnVsZScsXG4gICAgICAgICAgICByZW5kZXI6IHZpZXcgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGljb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICAgICAgICAgICAgICBpY29uLmNsYXNzTGlzdC5hZGQoJ2N1c3RvbS1pY29uJywgJ2hyLWljb24nKTtcbiAgICAgICAgICAgICAgICBjb25zdCBsYWJlbEVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpO1xuICAgICAgICAgICAgICAgIGxhYmVsRWwudGV4dENvbnRlbnQgPSAnSG9yaXpvbnRhbCBydWxlJztcbiAgICAgICAgICAgICAgICByZXR1cm4gd3JhcEluTWVudUl0ZW1XaXRoSWNvbihpY29uLCBsYWJlbEVsKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBlbmFibGUoc3RhdGUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gY2FuSW5zZXJ0KHN0YXRlLCBocik7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgcnVuKHN0YXRlOiBFZGl0b3JTdGF0ZSwgZGlzcGF0Y2gpIHtcbiAgICAgICAgICAgICAgICBkaXNwYXRjaChzdGF0ZS50ci5yZXBsYWNlU2VsZWN0aW9uV2l0aChoci5jcmVhdGUoKSkpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgY3V0ID0gPFQ+KGFycjogVFtdKTogVFtdID0+IGFyci5maWx0ZXIoeCA9PiB4KTtcbiAgICByLmluc2VydE1lbnUgPSBuZXcgRHJvcGRvd24oXG4gICAgICAgIGN1dChbXG4gICAgICAgICAgICByLmluc2VydEltYWdlLFxuICAgICAgICAgICAgci5pbnNlcnRIb3Jpem9udGFsUnVsZSxcbiAgICAgICAgICAgIG5ldyBNZW51SXRlbSh7XG4gICAgICAgICAgICAgICAgcnVuOiAoc3RhdGUsIGRpc3BhdGNoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGFkZFRhYmxlKHN0YXRlLCBkaXNwYXRjaCwge1xuICAgICAgICAgICAgICAgICAgICAgICAgcm93c0NvdW50OiAyLFxuICAgICAgICAgICAgICAgICAgICAgICAgY29sc0NvdW50OiAyLFxuICAgICAgICAgICAgICAgICAgICAgICAgd2l0aEhlYWRlclJvdzogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNlbGxDb250ZW50OiAnJyxcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICByZW5kZXI6IHJlbmRlckNsYXJpdHlJY29uKHsgc2hhcGU6ICd0YWJsZScsIGxhYmVsOiAnVGFibGUnIH0pLFxuICAgICAgICAgICAgfSksXG4gICAgICAgIF0pLFxuICAgICAgICB7IGxhYmVsOiAnSW5zZXJ0JyB9LFxuICAgICk7XG4gICAgci50eXBlTWVudSA9IG5ldyBEcm9wZG93bihcbiAgICAgICAgY3V0KFtcbiAgICAgICAgICAgIHIubWFrZVBhcmFncmFwaCxcbiAgICAgICAgICAgIHIubWFrZUNvZGVCbG9jayxcbiAgICAgICAgICAgIHIubWFrZUhlYWQxICYmXG4gICAgICAgICAgICAgICAgbmV3IFN1Yk1lbnVXaXRoSWNvbihcbiAgICAgICAgICAgICAgICAgICAgY3V0KFtyLm1ha2VIZWFkMSwgci5tYWtlSGVhZDIsIHIubWFrZUhlYWQzLCByLm1ha2VIZWFkNCwgci5tYWtlSGVhZDUsIHIubWFrZUhlYWQ2XSksXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOiAnSGVhZGluZycsXG4gICAgICAgICAgICAgICAgICAgICAgICBpY29uOiAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaWNvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGljb24udGV4dENvbnRlbnQgPSAnSCc7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWNvbi5jbGFzc0xpc3QuYWRkKCdjdXN0b20taWNvbicsICdoLWljb24nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaWNvbjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgKSxcbiAgICAgICAgXSksXG4gICAgICAgIHsgbGFiZWw6ICdUeXBlLi4uJyB9LFxuICAgICk7XG5cbiAgICBjb25zdCBpbmxpbmVNZW51ID0gY3V0KFtyLnRvZ2dsZVN0cm9uZywgci50b2dnbGVFbSwgci50b2dnbGVMaW5rXSk7XG4gICAgci5pbmxpbmVNZW51ID0gW2lubGluZU1lbnVdO1xuICAgIHIuYmxvY2tNZW51ID0gW1xuICAgICAgICBjdXQoW1xuICAgICAgICAgICAgci53cmFwQnVsbGV0TGlzdCxcbiAgICAgICAgICAgIHIud3JhcE9yZGVyZWRMaXN0LFxuICAgICAgICAgICAgci53cmFwQmxvY2tRdW90ZSxcbiAgICAgICAgICAgIGpvaW5VcEl0ZW0sXG4gICAgICAgICAgICBsaWZ0SXRlbSxcbiAgICAgICAgICAgIHNlbGVjdFBhcmVudE5vZGVJdGVtLFxuICAgICAgICBdKSxcbiAgICBdO1xuICAgIGNvbnN0IHVuZG9SZWRvID0gW1xuICAgICAgICBuZXcgTWVudUl0ZW0oe1xuICAgICAgICAgICAgdGl0bGU6ICdVbmRvIGxhc3QgY2hhbmdlJyxcbiAgICAgICAgICAgIHJ1bjogdW5kbyxcbiAgICAgICAgICAgIGVuYWJsZShzdGF0ZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB1bmRvKHN0YXRlKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICByZW5kZXI6IHJlbmRlckNsYXJpdHlJY29uKHsgc2hhcGU6ICd1bmRvJywgc2l6ZTogSWNvblNpemUuTGFyZ2UgfSksXG4gICAgICAgIH0pLFxuICAgICAgICBuZXcgTWVudUl0ZW0oe1xuICAgICAgICAgICAgdGl0bGU6ICdSZWRvIGxhc3QgdW5kb25lIGNoYW5nZScsXG4gICAgICAgICAgICBydW46IHJlZG8sXG4gICAgICAgICAgICBlbmFibGUoc3RhdGUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVkbyhzdGF0ZSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgcmVuZGVyOiByZW5kZXJDbGFyaXR5SWNvbih7IHNoYXBlOiAncmVkbycsIHNpemU6IEljb25TaXplLkxhcmdlIH0pLFxuICAgICAgICB9KSxcbiAgICBdO1xuICAgIHIuZnVsbE1lbnUgPSBbaW5saW5lTWVudV0uY29uY2F0KFtbci5pbnNlcnRNZW51LCByLnR5cGVNZW51XV0sIFt1bmRvUmVkb10sIHIuYmxvY2tNZW51KTtcblxuICAgIHJldHVybiByO1xufVxuIl19