import { marker as _ } from '@biesbjerg/ngx-translate-extract-marker';
import { currentChannelIsNotDefault, DataService, DeletionResult, getChannelCodeFromUserStatus, isMultiChannel, ModalService, NotificationService, Permission, } from '@vendure/admin-ui/core';
import { unique } from '@vendure/common/lib/unique';
import { EMPTY, of } from 'rxjs';
import { map, mapTo, switchMap } from 'rxjs/operators';
import { AssignToChannelDialogComponent } from '../assign-to-channel-dialog/assign-to-channel-dialog.component';
const ɵ0 = userPermissions => userPermissions.includes(Permission.DeleteFacet) ||
    userPermissions.includes(Permission.DeleteCatalog), ɵ1 = ({ injector, selection, hostComponent, clearSelection }) => {
    const modalService = injector.get(ModalService);
    const dataService = injector.get(DataService);
    const notificationService = injector.get(NotificationService);
    function showModalAndDelete(facetIds, message) {
        return modalService
            .dialog({
            title: _('catalog.confirm-bulk-delete-facets'),
            translationVars: {
                count: selection.length,
            },
            size: message ? 'lg' : 'md',
            body: message,
            buttons: [
                { type: 'secondary', label: _('common.cancel') },
                {
                    type: 'danger',
                    label: message ? _('common.force-delete') : _('common.delete'),
                    returnValue: true,
                },
            ],
        })
            .pipe(switchMap(res => res
            ? dataService.facet
                .deleteFacets(facetIds, !!message)
                .pipe(map(res2 => res2.deleteFacets))
            : of([])));
    }
    showModalAndDelete(unique(selection.map(f => f.id)))
        .pipe(switchMap(result => {
        var _a;
        let deletedCount = 0;
        const errors = [];
        const errorIds = [];
        let i = 0;
        for (const item of result) {
            if (item.result === DeletionResult.DELETED) {
                deletedCount++;
            }
            else if (item.message) {
                errors.push(item.message);
                errorIds.push((_a = selection[i]) === null || _a === void 0 ? void 0 : _a.id);
            }
            i++;
        }
        if (0 < errorIds.length) {
            return showModalAndDelete(errorIds, errors.join('\n')).pipe(map(result2 => {
                const deletedCount2 = result2.filter(r => r.result === DeletionResult.DELETED).length;
                return deletedCount + deletedCount2;
            }));
        }
        else {
            return of(deletedCount);
        }
    }))
        .subscribe(deletedCount => {
        if (deletedCount) {
            hostComponent.refresh();
            clearSelection();
            notificationService.success(_('catalog.notify-bulk-delete-facets-success'), {
                count: deletedCount,
            });
        }
    });
};
export const deleteFacetsBulkAction = {
    location: 'facet-list',
    label: _('common.delete'),
    icon: 'trash',
    iconClass: 'is-danger',
    requiresPermission: ɵ0,
    onClick: ɵ1,
};
const ɵ2 = userPermissions => userPermissions.includes(Permission.UpdateFacet) ||
    userPermissions.includes(Permission.UpdateCatalog), ɵ3 = ({ injector }) => isMultiChannel(injector.get(DataService)), ɵ4 = ({ injector, selection, hostComponent, clearSelection }) => {
    const modalService = injector.get(ModalService);
    const dataService = injector.get(DataService);
    const notificationService = injector.get(NotificationService);
    modalService
        .fromComponent(AssignToChannelDialogComponent, {
        size: 'md',
        locals: {},
    })
        .pipe(switchMap(result => {
        if (result) {
            return dataService.facet
                .assignFacetsToChannel({
                facetIds: selection.map(f => f.id),
                channelId: result.id,
            })
                .pipe(mapTo(result));
        }
        else {
            return EMPTY;
        }
    }))
        .subscribe(result => {
        notificationService.success(_('catalog.assign-facets-to-channel-success'), {
            count: selection.length,
            channelCode: result.code,
        });
        clearSelection();
    });
};
export const assignFacetsToChannelBulkAction = {
    location: 'facet-list',
    label: _('catalog.assign-to-channel'),
    icon: 'layers',
    requiresPermission: ɵ2,
    isVisible: ɵ3,
    onClick: ɵ4,
};
const ɵ5 = ({ injector }) => getChannelCodeFromUserStatus(injector.get(DataService)), ɵ6 = userPermissions => userPermissions.includes(Permission.UpdateFacet) ||
    userPermissions.includes(Permission.UpdateCatalog), ɵ7 = ({ injector }) => currentChannelIsNotDefault(injector.get(DataService)), ɵ8 = ({ injector, selection, hostComponent, clearSelection }) => {
    const modalService = injector.get(ModalService);
    const dataService = injector.get(DataService);
    const notificationService = injector.get(NotificationService);
    const activeChannelId$ = dataService.client
        .userStatus()
        .mapSingle(({ userStatus }) => userStatus.activeChannelId);
    function showModalAndDelete(facetIds, message) {
        return modalService
            .dialog({
            title: _('catalog.remove-from-channel'),
            translationVars: {
                count: selection.length,
            },
            size: message ? 'lg' : 'md',
            body: message,
            buttons: [
                { type: 'secondary', label: _('common.cancel') },
                {
                    type: 'danger',
                    label: message ? _('common.force-remove') : _('common.remove'),
                    returnValue: true,
                },
            ],
        })
            .pipe(switchMap(res => res
            ? activeChannelId$.pipe(switchMap(activeChannelId => activeChannelId
                ? dataService.facet.removeFacetsFromChannel({
                    channelId: activeChannelId,
                    facetIds,
                    force: !!message,
                })
                : EMPTY), map(res2 => res2.removeFacetsFromChannel))
            : EMPTY));
    }
    showModalAndDelete(unique(selection.map(f => f.id)))
        .pipe(switchMap(result => {
        var _a;
        let removedCount = selection.length;
        const errors = [];
        const errorIds = [];
        let i = 0;
        for (const item of result) {
            if (item.__typename === 'FacetInUseError') {
                errors.push(item.message);
                errorIds.push((_a = selection[i]) === null || _a === void 0 ? void 0 : _a.id);
                removedCount--;
            }
            i++;
        }
        if (0 < errorIds.length) {
            return showModalAndDelete(errorIds, errors.join('\n')).pipe(map(result2 => {
                const notRemovedCount = result2.filter(r => r.__typename === 'FacetInUseError').length;
                return selection.length - notRemovedCount;
            }));
        }
        else {
            return of(removedCount);
        }
    }), switchMap(removedCount => removedCount
        ? getChannelCodeFromUserStatus(dataService).then(({ channelCode }) => ({
            channelCode,
            removedCount,
        }))
        : EMPTY))
        .subscribe(({ removedCount, channelCode }) => {
        if (removedCount) {
            hostComponent.refresh();
            clearSelection();
            notificationService.success(_('catalog.notify-remove-facets-from-channel-success'), {
                count: removedCount,
                channelCode,
            });
        }
    });
};
export const removeFacetsFromChannelBulkAction = {
    location: 'facet-list',
    label: _('catalog.remove-from-channel'),
    getTranslationVars: ɵ5,
    icon: 'layers',
    iconClass: 'is-warning',
    requiresPermission: ɵ6,
    isVisible: ɵ7,
    onClick: ɵ8,
};
export { ɵ0, ɵ1, ɵ2, ɵ3, ɵ4, ɵ5, ɵ6, ɵ7, ɵ8 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFjZXQtbGlzdC1idWxrLWFjdGlvbnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvbGliL2NhdGFsb2cvc3JjL2NvbXBvbmVudHMvZmFjZXQtbGlzdC9mYWNldC1saXN0LWJ1bGstYWN0aW9ucy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxJQUFJLENBQUMsRUFBRSxNQUFNLHlDQUF5QyxDQUFDO0FBQ3RFLE9BQU8sRUFFSCwwQkFBMEIsRUFDMUIsV0FBVyxFQUNYLGNBQWMsRUFDZCw0QkFBNEIsRUFFNUIsY0FBYyxFQUNkLFlBQVksRUFDWixtQkFBbUIsRUFDbkIsVUFBVSxHQUNiLE1BQU0sd0JBQXdCLENBQUM7QUFDaEMsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQ3BELE9BQU8sRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2pDLE9BQU8sRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXZELE9BQU8sRUFBRSw4QkFBOEIsRUFBRSxNQUFNLGdFQUFnRSxDQUFDO1dBU3hGLGVBQWUsQ0FBQyxFQUFFLENBQ2xDLGVBQWUsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQztJQUNoRCxlQUFlLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUMsT0FDN0MsQ0FBQyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsYUFBYSxFQUFFLGNBQWMsRUFBRSxFQUFFLEVBQUU7SUFDaEUsTUFBTSxZQUFZLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUNoRCxNQUFNLFdBQVcsR0FBRyxRQUFRLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQzlDLE1BQU0sbUJBQW1CLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxtQkFB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TSxpQ0FBaUMsR0FBdUQ7SUFDakcsUUFBUSxFQUFFLFlBQVk7SUFDdEIsS0FBSyxFQUFFLENBQUMsQ0FBQyw2QkFBNkIsQ0FBQztJQUN2QyxrQkFBa0IsSUFBMkU7SUFDN0YsSUFBSSxFQUFFLFFBQVE7SUFDZCxTQUFTLEVBQUUsWUFBWTtJQUN2QixrQkFBa0IsSUFFb0M7SUFDdEQsU0FBUyxJQUF5RTtJQUNsRixPQUFPLElBOEZOO0NBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IG1hcmtlciBhcyBfIH0gZnJvbSAnQGJpZXNiamVyZy9uZ3gtdHJhbnNsYXRlLWV4dHJhY3QtbWFya2VyJztcbmltcG9ydCB7XG4gICAgQnVsa0FjdGlvbixcbiAgICBjdXJyZW50Q2hhbm5lbElzTm90RGVmYXVsdCxcbiAgICBEYXRhU2VydmljZSxcbiAgICBEZWxldGlvblJlc3VsdCxcbiAgICBnZXRDaGFubmVsQ29kZUZyb21Vc2VyU3RhdHVzLFxuICAgIEdldEZhY2V0TGlzdCxcbiAgICBpc011bHRpQ2hhbm5lbCxcbiAgICBNb2RhbFNlcnZpY2UsXG4gICAgTm90aWZpY2F0aW9uU2VydmljZSxcbiAgICBQZXJtaXNzaW9uLFxufSBmcm9tICdAdmVuZHVyZS9hZG1pbi11aS9jb3JlJztcbmltcG9ydCB7IHVuaXF1ZSB9IGZyb20gJ0B2ZW5kdXJlL2NvbW1vbi9saWIvdW5pcXVlJztcbmltcG9ydCB7IEVNUFRZLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWFwLCBtYXBUbywgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBBc3NpZ25Ub0NoYW5uZWxEaWFsb2dDb21wb25lbnQgfSBmcm9tICcuLi9hc3NpZ24tdG8tY2hhbm5lbC1kaWFsb2cvYXNzaWduLXRvLWNoYW5uZWwtZGlhbG9nLmNvbXBvbmVudCc7XG5cbmltcG9ydCB7IEZhY2V0TGlzdENvbXBvbmVudCB9IGZyb20gJy4vZmFjZXQtbGlzdC5jb21wb25lbnQnO1xuXG5leHBvcnQgY29uc3QgZGVsZXRlRmFjZXRzQnVsa0FjdGlvbjogQnVsa0FjdGlvbjxHZXRGYWNldExpc3QuSXRlbXMsIEZhY2V0TGlzdENvbXBvbmVudD4gPSB7XG4gICAgbG9jYXRpb246ICdmYWNldC1saXN0JyxcbiAgICBsYWJlbDogXygnY29tbW9uLmRlbGV0ZScpLFxuICAgIGljb246ICd0cmFzaCcsXG4gICAgaWNvbkNsYXNzOiAnaXMtZGFuZ2VyJyxcbiAgICByZXF1aXJlc1Blcm1pc3Npb246IHVzZXJQZXJtaXNzaW9ucyA9PlxuICAgICAgICB1c2VyUGVybWlzc2lvbnMuaW5jbHVkZXMoUGVybWlzc2lvbi5EZWxldGVGYWNldCkgfHxcbiAgICAgICAgdXNlclBlcm1pc3Npb25zLmluY2x1ZGVzKFBlcm1pc3Npb24uRGVsZXRlQ2F0YWxvZyksXG4gICAgb25DbGljazogKHsgaW5qZWN0b3IsIHNlbGVjdGlvbiwgaG9zdENvbXBvbmVudCwgY2xlYXJTZWxlY3Rpb24gfSkgPT4ge1xuICAgICAgICBjb25zdCBtb2RhbFNlcnZpY2UgPSBpbmplY3Rvci5nZXQoTW9kYWxTZXJ2aWNlKTtcbiAgICAgICAgY29uc3QgZGF0YVNlcnZpY2UgPSBpbmplY3Rvci5nZXQoRGF0YVNlcnZpY2UpO1xuICAgICAgICBjb25zdCBub3RpZmljYXRpb25TZXJ2aWNlID0gaW5qZWN0b3IuZ2V0KE5vdGlmaWNhdGlvblNlcnZpY2UpO1xuXG4gICAgICAgIGZ1bmN0aW9uIHNob3dNb2RhbEFuZERlbGV0ZShmYWNldElkczogc3RyaW5nW10sIG1lc3NhZ2U/OiBzdHJpbmcpIHtcbiAgICAgICAgICAgIHJldHVybiBtb2RhbFNlcnZpY2VcbiAgICAgICAgICAgICAgICAuZGlhbG9nKHtcbiAgICAgICAgICAgICAgICAgICAgdGl0bGU6IF8oJ2NhdGFsb2cuY29uZmlybS1idWxrLWRlbGV0ZS1mYWNldHMnKSxcbiAgICAgICAgICAgICAgICAgICAgdHJhbnNsYXRpb25WYXJzOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb3VudDogc2VsZWN0aW9uLmxlbmd0aCxcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgc2l6ZTogbWVzc2FnZSA/ICdsZycgOiAnbWQnLFxuICAgICAgICAgICAgICAgICAgICBib2R5OiBtZXNzYWdlLFxuICAgICAgICAgICAgICAgICAgICBidXR0b25zOiBbXG4gICAgICAgICAgICAgICAgICAgICAgICB7IHR5cGU6ICdzZWNvbmRhcnknLCBsYWJlbDogXygnY29tbW9uLmNhbmNlbCcpIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2RhbmdlcicsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6IG1lc3NhZ2UgPyBfKCdjb21tb24uZm9yY2UtZGVsZXRlJykgOiBfKCdjb21tb24uZGVsZXRlJyksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuVmFsdWU6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgIHN3aXRjaE1hcChyZXMgPT5cbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gZGF0YVNlcnZpY2UuZmFjZXRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZGVsZXRlRmFjZXRzKGZhY2V0SWRzLCAhIW1lc3NhZ2UpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnBpcGUobWFwKHJlczIgPT4gcmVzMi5kZWxldGVGYWNldHMpKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogb2YoW10pLFxuICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICBzaG93TW9kYWxBbmREZWxldGUodW5pcXVlKHNlbGVjdGlvbi5tYXAoZiA9PiBmLmlkKSkpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBzd2l0Y2hNYXAocmVzdWx0ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGRlbGV0ZWRDb3VudCA9IDA7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGVycm9yczogc3RyaW5nW10gPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZXJyb3JJZHM6IHN0cmluZ1tdID0gW107XG4gICAgICAgICAgICAgICAgICAgIGxldCBpID0gMDtcbiAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBpdGVtIG9mIHJlc3VsdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0ucmVzdWx0ID09PSBEZWxldGlvblJlc3VsdC5ERUxFVEVEKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlZENvdW50Kys7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGl0ZW0ubWVzc2FnZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9ycy5wdXNoKGl0ZW0ubWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JJZHMucHVzaChzZWxlY3Rpb25baV0/LmlkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGkrKztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoMCA8IGVycm9ySWRzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNob3dNb2RhbEFuZERlbGV0ZShlcnJvcklkcywgZXJyb3JzLmpvaW4oJ1xcbicpKS5waXBlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcChyZXN1bHQyID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGVsZXRlZENvdW50MiA9IHJlc3VsdDIuZmlsdGVyKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgciA9PiByLnJlc3VsdCA9PT0gRGVsZXRpb25SZXN1bHQuREVMRVRFRCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKS5sZW5ndGg7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkZWxldGVkQ291bnQgKyBkZWxldGVkQ291bnQyO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvZihkZWxldGVkQ291bnQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICApXG4gICAgICAgICAgICAuc3Vic2NyaWJlKGRlbGV0ZWRDb3VudCA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGRlbGV0ZWRDb3VudCkge1xuICAgICAgICAgICAgICAgICAgICBob3N0Q29tcG9uZW50LnJlZnJlc2goKTtcbiAgICAgICAgICAgICAgICAgICAgY2xlYXJTZWxlY3Rpb24oKTtcbiAgICAgICAgICAgICAgICAgICAgbm90aWZpY2F0aW9uU2VydmljZS5zdWNjZXNzKF8oJ2NhdGFsb2cubm90aWZ5LWJ1bGstZGVsZXRlLWZhY2V0cy1zdWNjZXNzJyksIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50OiBkZWxldGVkQ291bnQsXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgIH0sXG59O1xuXG5leHBvcnQgY29uc3QgYXNzaWduRmFjZXRzVG9DaGFubmVsQnVsa0FjdGlvbjogQnVsa0FjdGlvbjxHZXRGYWNldExpc3QuSXRlbXMsIEZhY2V0TGlzdENvbXBvbmVudD4gPSB7XG4gICAgbG9jYXRpb246ICdmYWNldC1saXN0JyxcbiAgICBsYWJlbDogXygnY2F0YWxvZy5hc3NpZ24tdG8tY2hhbm5lbCcpLFxuICAgIGljb246ICdsYXllcnMnLFxuICAgIHJlcXVpcmVzUGVybWlzc2lvbjogdXNlclBlcm1pc3Npb25zID0+XG4gICAgICAgIHVzZXJQZXJtaXNzaW9ucy5pbmNsdWRlcyhQZXJtaXNzaW9uLlVwZGF0ZUZhY2V0KSB8fFxuICAgICAgICB1c2VyUGVybWlzc2lvbnMuaW5jbHVkZXMoUGVybWlzc2lvbi5VcGRhdGVDYXRhbG9nKSxcbiAgICBpc1Zpc2libGU6ICh7IGluamVjdG9yIH0pID0+IGlzTXVsdGlDaGFubmVsKGluamVjdG9yLmdldChEYXRhU2VydmljZSkpLFxuICAgIG9uQ2xpY2s6ICh7IGluamVjdG9yLCBzZWxlY3Rpb24sIGhvc3RDb21wb25lbnQsIGNsZWFyU2VsZWN0aW9uIH0pID0+IHtcbiAgICAgICAgY29uc3QgbW9kYWxTZXJ2aWNlID0gaW5qZWN0b3IuZ2V0KE1vZGFsU2VydmljZSk7XG4gICAgICAgIGNvbnN0IGRhdGFTZXJ2aWNlID0gaW5qZWN0b3IuZ2V0KERhdGFTZXJ2aWNlKTtcbiAgICAgICAgY29uc3Qgbm90aWZpY2F0aW9uU2VydmljZSA9IGluamVjdG9yLmdldChOb3RpZmljYXRpb25TZXJ2aWNlKTtcbiAgICAgICAgbW9kYWxTZXJ2aWNlXG4gICAgICAgICAgICAuZnJvbUNvbXBvbmVudChBc3NpZ25Ub0NoYW5uZWxEaWFsb2dDb21wb25lbnQsIHtcbiAgICAgICAgICAgICAgICBzaXplOiAnbWQnLFxuICAgICAgICAgICAgICAgIGxvY2Fsczoge30sXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgc3dpdGNoTWFwKHJlc3VsdCA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkYXRhU2VydmljZS5mYWNldFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5hc3NpZ25GYWNldHNUb0NoYW5uZWwoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWNldElkczogc2VsZWN0aW9uLm1hcChmID0+IGYuaWQpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFubmVsSWQ6IHJlc3VsdC5pZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5waXBlKG1hcFRvKHJlc3VsdCkpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEVNUFRZO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICApXG4gICAgICAgICAgICAuc3Vic2NyaWJlKHJlc3VsdCA9PiB7XG4gICAgICAgICAgICAgICAgbm90aWZpY2F0aW9uU2VydmljZS5zdWNjZXNzKF8oJ2NhdGFsb2cuYXNzaWduLWZhY2V0cy10by1jaGFubmVsLXN1Y2Nlc3MnKSwge1xuICAgICAgICAgICAgICAgICAgICBjb3VudDogc2VsZWN0aW9uLmxlbmd0aCxcbiAgICAgICAgICAgICAgICAgICAgY2hhbm5lbENvZGU6IHJlc3VsdC5jb2RlLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGNsZWFyU2VsZWN0aW9uKCk7XG4gICAgICAgICAgICB9KTtcbiAgICB9LFxufTtcblxuZXhwb3J0IGNvbnN0IHJlbW92ZUZhY2V0c0Zyb21DaGFubmVsQnVsa0FjdGlvbjogQnVsa0FjdGlvbjxHZXRGYWNldExpc3QuSXRlbXMsIEZhY2V0TGlzdENvbXBvbmVudD4gPSB7XG4gICAgbG9jYXRpb246ICdmYWNldC1saXN0JyxcbiAgICBsYWJlbDogXygnY2F0YWxvZy5yZW1vdmUtZnJvbS1jaGFubmVsJyksXG4gICAgZ2V0VHJhbnNsYXRpb25WYXJzOiAoeyBpbmplY3RvciB9KSA9PiBnZXRDaGFubmVsQ29kZUZyb21Vc2VyU3RhdHVzKGluamVjdG9yLmdldChEYXRhU2VydmljZSkpLFxuICAgIGljb246ICdsYXllcnMnLFxuICAgIGljb25DbGFzczogJ2lzLXdhcm5pbmcnLFxuICAgIHJlcXVpcmVzUGVybWlzc2lvbjogdXNlclBlcm1pc3Npb25zID0+XG4gICAgICAgIHVzZXJQZXJtaXNzaW9ucy5pbmNsdWRlcyhQZXJtaXNzaW9uLlVwZGF0ZUZhY2V0KSB8fFxuICAgICAgICB1c2VyUGVybWlzc2lvbnMuaW5jbHVkZXMoUGVybWlzc2lvbi5VcGRhdGVDYXRhbG9nKSxcbiAgICBpc1Zpc2libGU6ICh7IGluamVjdG9yIH0pID0+IGN1cnJlbnRDaGFubmVsSXNOb3REZWZhdWx0KGluamVjdG9yLmdldChEYXRhU2VydmljZSkpLFxuICAgIG9uQ2xpY2s6ICh7IGluamVjdG9yLCBzZWxlY3Rpb24sIGhvc3RDb21wb25lbnQsIGNsZWFyU2VsZWN0aW9uIH0pID0+IHtcbiAgICAgICAgY29uc3QgbW9kYWxTZXJ2aWNlID0gaW5qZWN0b3IuZ2V0KE1vZGFsU2VydmljZSk7XG4gICAgICAgIGNvbnN0IGRhdGFTZXJ2aWNlID0gaW5qZWN0b3IuZ2V0KERhdGFTZXJ2aWNlKTtcbiAgICAgICAgY29uc3Qgbm90aWZpY2F0aW9uU2VydmljZSA9IGluamVjdG9yLmdldChOb3RpZmljYXRpb25TZXJ2aWNlKTtcblxuICAgICAgICBjb25zdCBhY3RpdmVDaGFubmVsSWQkID0gZGF0YVNlcnZpY2UuY2xpZW50XG4gICAgICAgICAgICAudXNlclN0YXR1cygpXG4gICAgICAgICAgICAubWFwU2luZ2xlKCh7IHVzZXJTdGF0dXMgfSkgPT4gdXNlclN0YXR1cy5hY3RpdmVDaGFubmVsSWQpO1xuXG4gICAgICAgIGZ1bmN0aW9uIHNob3dNb2RhbEFuZERlbGV0ZShmYWNldElkczogc3RyaW5nW10sIG1lc3NhZ2U/OiBzdHJpbmcpIHtcbiAgICAgICAgICAgIHJldHVybiBtb2RhbFNlcnZpY2VcbiAgICAgICAgICAgICAgICAuZGlhbG9nKHtcbiAgICAgICAgICAgICAgICAgICAgdGl0bGU6IF8oJ2NhdGFsb2cucmVtb3ZlLWZyb20tY2hhbm5lbCcpLFxuICAgICAgICAgICAgICAgICAgICB0cmFuc2xhdGlvblZhcnM6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50OiBzZWxlY3Rpb24ubGVuZ3RoLFxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBzaXplOiBtZXNzYWdlID8gJ2xnJyA6ICdtZCcsXG4gICAgICAgICAgICAgICAgICAgIGJvZHk6IG1lc3NhZ2UsXG4gICAgICAgICAgICAgICAgICAgIGJ1dHRvbnM6IFtcbiAgICAgICAgICAgICAgICAgICAgICAgIHsgdHlwZTogJ3NlY29uZGFyeScsIGxhYmVsOiBfKCdjb21tb24uY2FuY2VsJykgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAnZGFuZ2VyJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDogbWVzc2FnZSA/IF8oJ2NvbW1vbi5mb3JjZS1yZW1vdmUnKSA6IF8oJ2NvbW1vbi5yZW1vdmUnKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm5WYWx1ZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICAgICAgc3dpdGNoTWFwKHJlcyA9PlxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBhY3RpdmVDaGFubmVsSWQkLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoTWFwKGFjdGl2ZUNoYW5uZWxJZCA9PlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3RpdmVDaGFubmVsSWRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gZGF0YVNlcnZpY2UuZmFjZXQucmVtb3ZlRmFjZXRzRnJvbUNoYW5uZWwoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhbm5lbElkOiBhY3RpdmVDaGFubmVsSWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWNldElkcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcmNlOiAhIW1lc3NhZ2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IEVNUFRZLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwKHJlczIgPT4gcmVzMi5yZW1vdmVGYWNldHNGcm9tQ2hhbm5lbCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBFTVBUWSxcbiAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgc2hvd01vZGFsQW5kRGVsZXRlKHVuaXF1ZShzZWxlY3Rpb24ubWFwKGYgPT4gZi5pZCkpKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgc3dpdGNoTWFwKHJlc3VsdCA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGxldCByZW1vdmVkQ291bnQgPSBzZWxlY3Rpb24ubGVuZ3RoO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBlcnJvcnM6IHN0cmluZ1tdID0gW107XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGVycm9ySWRzOiBzdHJpbmdbXSA9IFtdO1xuICAgICAgICAgICAgICAgICAgICBsZXQgaSA9IDA7XG4gICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgaXRlbSBvZiByZXN1bHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLl9fdHlwZW5hbWUgPT09ICdGYWNldEluVXNlRXJyb3InKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JzLnB1c2goaXRlbS5tZXNzYWdlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcklkcy5wdXNoKHNlbGVjdGlvbltpXT8uaWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbW92ZWRDb3VudC0tO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaSsrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmICgwIDwgZXJyb3JJZHMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2hvd01vZGFsQW5kRGVsZXRlKGVycm9ySWRzLCBlcnJvcnMuam9pbignXFxuJykpLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwKHJlc3VsdDIgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBub3RSZW1vdmVkQ291bnQgPSByZXN1bHQyLmZpbHRlcihcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHIgPT4gci5fX3R5cGVuYW1lID09PSAnRmFjZXRJblVzZUVycm9yJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKS5sZW5ndGg7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzZWxlY3Rpb24ubGVuZ3RoIC0gbm90UmVtb3ZlZENvdW50O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvZihyZW1vdmVkQ291bnQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgc3dpdGNoTWFwKHJlbW92ZWRDb3VudCA9PlxuICAgICAgICAgICAgICAgICAgICByZW1vdmVkQ291bnRcbiAgICAgICAgICAgICAgICAgICAgICAgID8gZ2V0Q2hhbm5lbENvZGVGcm9tVXNlclN0YXR1cyhkYXRhU2VydmljZSkudGhlbigoeyBjaGFubmVsQ29kZSB9KSA9PiAoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhbm5lbENvZGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVkQ291bnQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgIH0pKVxuICAgICAgICAgICAgICAgICAgICAgICAgOiBFTVBUWSxcbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgLnN1YnNjcmliZSgoeyByZW1vdmVkQ291bnQsIGNoYW5uZWxDb2RlIH0pID0+IHtcbiAgICAgICAgICAgICAgICBpZiAocmVtb3ZlZENvdW50KSB7XG4gICAgICAgICAgICAgICAgICAgIGhvc3RDb21wb25lbnQucmVmcmVzaCgpO1xuICAgICAgICAgICAgICAgICAgICBjbGVhclNlbGVjdGlvbigpO1xuICAgICAgICAgICAgICAgICAgICBub3RpZmljYXRpb25TZXJ2aWNlLnN1Y2Nlc3MoXygnY2F0YWxvZy5ub3RpZnktcmVtb3ZlLWZhY2V0cy1mcm9tLWNoYW5uZWwtc3VjY2VzcycpLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb3VudDogcmVtb3ZlZENvdW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgY2hhbm5lbENvZGUsXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgIH0sXG59O1xuIl19